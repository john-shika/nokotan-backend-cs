using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.AspNetCore.OpenApi;
using Microsoft.OpenApi.Models;
using NokoWebApiSdk.Cores;
using NokoWebApiSdk.OpenApi;
using NokoWebApiSdk.OpenApi.Extensions;
using NokoWebApiSdk.Utils;
using Serilog;

namespace NokoWebApiSdk.Transformers;

public sealed class AutoGenerateDescriptionTransformer(IAuthenticationSchemeProvider authenticationSchemeProvider) : IOpenApiDocumentTransformer
{
    private static INokoWebLogger Logger => new NokoWebLogger();
    
    public async Task TransformAsync(OpenApiDocument document, OpenApiDocumentTransformerContext context, CancellationToken cancellationToken)
    {
        document.Preload();
        
        foreach (var (path, item) in document.Paths)
        {
            foreach (var (operationType, operation) in item.Operations)
            {
                if (NokoWebCommon.IsNoneOrEmptyOrWhiteSpace(operation.Summary)) continue;
                Logger.Warning($"Set Description On Method: {operationType}, Path: '{path}'");
                var value = NokoWebCommon.EndsCut(operation.Summary.Trim(), ".");
                var summary = NokoWebTransform.ToTitleCase(value.ToLower());
                var description = summary.EndsWith("Endpoint") ? summary : $"{summary} Endpoint";
                operation.Summary = summary;
                operation.Description ??= $"Description: {description}.";
            }
        }
    }
}